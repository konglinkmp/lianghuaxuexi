# A股量化交易决策辅助工具 - 量化方案说明

本方案旨在通过量化手段，在收盘后自动筛选符合“动能+趋势”特征的股票，并结合**分层策略**与**自适应风控**，生成次日操作计划，帮助投资者规避情绪化交易。

---

## 1. 核心逻辑架构

方案采用模块化设计，集成了数据获取、分层策略、自适应风控与消息推送等功能。

```mermaid
graph TD
    A[收盘后运行] --> B{大盘风险检查}
    B -- 风险大 --> C[提示风险, 停止买入]
    B -- 正常 --> D[获取股票池]
    D --> E[基础过滤: 剔除ST/新股]
    E --> F{市场状态识别}
    F --> G[自适应参数调整]
    G --> H[分层策略分析]
    H --> I[稳健层: 价值+趋势]
    H --> J[激进层: 热门+资金]
    I & J --> K[生成明日操作清单]
    K --> L[消息推送 (Bark/钉钉)]
    K --> M[导出 CSV & 终端显示]
```

---

## 2. 详细方案设计

### 2.1 选股范围 (Stock Pool)
- **全A股筛选**：默认遍历全市场 5000+ 只股票。
- **硬性过滤**：
    - **剔除 ST/退市股**：规避退市风险。
    - **剔除新股**：要求上市满 1 年。
- **自定义支持**：支持导入用户自选股池。

### 2.2 分层策略体系 (Layered Strategy)
系统采用“双层策略”架构，以适应不同风险偏好的资金配置。

#### A. 稳健层 (Conservative Layer) - 20% 仓位
- **目标**：捕捉业绩优良且处于上升趋势的白马股。
- **筛选标准**：
    1.  **基本面**：PE (0-50), PB (0-5)。
    2.  **趋势**：股价位于 MA20 之上 (Price > MA20)。
    3.  **量能**：成交量温和放大 (量比 ≥ 1.3)。
- **风控**：较宽的止损止盈幅度，适合中线持有。

#### B. 激进层 (Aggressive Layer) - 80% 仓位
- **目标**：捕捉市场热点和短线爆发力强的股票。
- **筛选标准**（满足任一即可）：
    1.  **高热度**：PE > 80 且 换手率 > 8%。
    2.  **强动能**：10日动量 > 25%。
    3.  **巨量**：成交量异常放大 (量比 > 3.0)。
    4.  **概念**：属于热门概念板块。
    5.  **资金流向**（加分项）：主力资金净流入+10分、成交量放大+5分、换手率活跃+5分、价格强势+5分。
- **风控**：严格的止损（如 -8%），快速止盈，适合短线博弈。

### 2.3 自适应风控 (Adaptive Market Regime)
系统根据大盘（沪深300）的波动率和趋势，自动识别市场状态并调整参数：

| **Extreme (极端)** | 暴跌或暴涨 | **暂停买入**，仅处理持仓 |

#### 风格漂移监控 (Style Drift)
系统通过计算沪深300与中证1000的相对强度（RPS），识别当前市场是“大盘占优”还是“小盘占优”：
- **大盘占优**：当沪深300显著强于中证1000时，系统自动进入**防守模式**，提高稳健层资金比例（最高可达 80%）。
- **小盘占优**：恢复默认的激进配置，捕捉小票弹性。

#### 组合风控 (Portfolio Risk)
- **行业集中度**：单一行业持仓市值不得超过总资产的 30%。
- **相关性检测**：自动计算持仓股间的历史相关系数，平均相关性 > 0.7 时发出预警，防止“伪分散”。

### 2.4 交易信号与推送 (Notification)
- **生成时间**：每日收盘后（建议 15:30 后）。
- **推送渠道**：支持 **Bark (iOS)**、钉钉机器人、企业微信等。
- **内容包含**：
    - 股票代码/名称/板块
    - 建议买入价、止损价、止盈价
    - 建议仓位（股数/金额）
    - 策略归属（稳健/激进）

---

## 3. 交易计划生成 (Plan Generator)

系统输出的“明日操作清单”直接对接券商 App 的**条件单**功能：

| 字段 | 对应券商 App 操作 |
| :--- | :--- |
| **建议买入价** | 设定为条件单的“价格触发”参考 |
| **止损触发价** | 设定为“价格跌破”条件单 |
| **止盈触发价** | 设定为“价格涨破”条件单 |
| **建议仓位** | 自动计算建议股数，控制单只个股风险 |

---

## 4. 辅助工具 (Auxiliary Tools)

项目包含多个实用脚本，方便日常维护和分析：

- **`tools/check_holdings.py`**：持仓快速扫描，检查持仓股是否跌破均线。
- **`tools/analyze_stock.py`**：个股深度诊断，分析技术面和基本面指标。
- **`update_holdings.py`**：手动更新账户净值和持仓数据的脚本（用于同步券商数据）。

---

## 5. 方案优势
1.  **科学分层**：稳健与激进相结合，平衡收益与风险。
2.  **动态适应**：不使用一套参数打天下，根据市场环境自动调整。
3.  **自动化闭环**：从数据获取到策略分析再到消息推送，全流程自动化。
4.  **严格风控**：内置大盘熔断机制与个股止损保护。

---

## 6. 最新增强功能（2026.01）

### 6.1 回测风险警告
- **幸存者偏差检测**：回测时自动评估数据风险，提示实际收益可能被高估。
- **参数敏感性分析**：测试不同参数组合的稳定性，识别过拟合风险。

### 6.2 回测真实性增强
- **涨停买入限制**：开盘涨停时跳过买入，模拟真实交易场景。
- **跌停卖出模拟**：封死跌停时延迟卖出，体现流动性风险。

### 6.3 层间相关性检测
自动检测稳健层与激进层股票的相关性，高相关时警告分散效果有限。

### 6.4 执行增强 (Execution Enhancement)
- **竞价异常检测**：实时监控集合竞价，识别开盘涨停、大幅跳空等异常情况，自动撤单。
- **尾盘跳水监控**：监控 14:30 后的异常杀跌，保护利润。

### 6.5 工程化优化
- **统一日志系统**：`logs/quant.log` 记录运行日志。
- **数据缓存机制**：内存缓存 + SQLite 本地数据库，减少 API 调用。

---

> [!IMPORTANT]
> **风险提示**：量化方案基于历史数据回测和逻辑推导，不保证未来收益。实际操作中请务必考虑滑点、佣金及市场极端情况。

